{% extends "base.html" %}

{% block title %}Tools - MCP Gateway{% endblock %}

{% block content %}
<h2 style="margin-bottom: 24px;">Available Tools</h2>

{% if tools %}
<div class="card" style="margin-bottom: 24px;">
    <input type="text" id="tool-search" placeholder="Search tools..."
           style="width: 100%; padding: 12px 16px; border: none; border-radius: 8px;
                  background: var(--bg-secondary); color: var(--text-primary);
                  font-size: 1rem;"
           oninput="filterTools(this.value)">
</div>

<div class="tool-list" id="tools-list">
    {% for tool in tools %}
    <div class="card tool-card" data-name="{{ tool.name.lower() }}" data-server="{{ tool.server_id.lower() }}">
        <div class="card-header">
            <div>
                <h3 class="card-title" style="font-family: monospace;">{{ tool.name }}</h3>
                <div class="tool-server">Server: {{ tool.server_id }}</div>
            </div>
            <button class="btn btn-secondary" onclick="showToolDetails('{{ tool.server_id }}', '{{ tool.name }}')">
                View Schema
            </button>
        </div>
        <p style="color: var(--text-secondary); font-size: 0.9rem;">
            {{ tool.description or 'No description available' }}
        </p>
    </div>
    {% endfor %}
</div>

<!-- Tool Details Modal -->
<div id="tool-modal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8);
                            z-index: 1000; padding: 20px; overflow-y: auto;">
    <div style="max-width: 800px; margin: 40px auto;">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title" id="modal-tool-name">Tool Name</h3>
                <button class="btn btn-secondary" onclick="closeModal()">Close</button>
            </div>
            <div id="modal-content">Loading...</div>
        </div>
    </div>
</div>

<script>
function filterTools(query) {
    const cards = document.querySelectorAll('.tool-card');
    const q = query.toLowerCase();

    cards.forEach(card => {
        const name = card.dataset.name;
        const server = card.dataset.server;
        const matches = name.includes(q) || server.includes(q);
        card.style.display = matches ? 'block' : 'none';
    });
}

async function showToolDetails(serverId, toolName) {
    const modal = document.getElementById('tool-modal');
    const content = document.getElementById('modal-content');
    const title = document.getElementById('modal-tool-name');

    title.textContent = `${serverId}/${toolName}`;
    content.innerHTML = 'Loading...';
    modal.style.display = 'block';

    try {
        const response = await fetch(`/api/tools/${serverId}/${toolName}`);
        const data = await response.json();

        content.innerHTML = `
            <p style="margin-bottom: 16px; color: var(--text-secondary);">${data.description || 'No description'}</p>

            <h4 style="margin-bottom: 8px;">Input Schema</h4>
            <pre>${JSON.stringify(data.input_schema, null, 2)}</pre>

            <h4 style="margin: 16px 0 8px;">API Endpoint</h4>
            <code>POST /api/tools/${serverId}/${toolName}</code>

            <h4 style="margin: 16px 0 8px;">Example Request</h4>
            <pre>curl -X POST http://localhost:8085/api/tools/${serverId}/${toolName} \\
  -H "Content-Type: application/json" \\
  -d '{"arguments": {}}'</pre>
        `;
    } catch (error) {
        content.innerHTML = `<p class="error-message">Failed to load tool details: ${error.message}</p>`;
    }
}

function closeModal() {
    document.getElementById('tool-modal').style.display = 'none';
}

// Close modal on escape key
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') closeModal();
});

// Close modal on background click
document.getElementById('tool-modal').addEventListener('click', (e) => {
    if (e.target.id === 'tool-modal') closeModal();
});
</script>

{% else %}
<div class="card" style="text-align: center; padding: 48px;">
    <h3 style="margin-bottom: 12px;">No Tools Available</h3>
    <p style="color: var(--text-secondary); margin-bottom: 20px;">
        Enable some MCP servers to see their tools here.
    </p>
    <a href="/servers" class="btn btn-primary">Manage Servers</a>
</div>
{% endif %}
{% endblock %}
